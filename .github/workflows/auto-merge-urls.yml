name: Auto-merge Deployment URLs

on:
  pull_request:
    types: [opened, synchronize]
    branches: [main]

permissions:
  contents: write
  pull-requests: write
  checks: read

jobs:
  auto-merge-deployment-urls:
    name: Auto-merge URL Updates
    runs-on: ubuntu-latest
    if: contains(github.event.pull_request.labels.*.name, 'automated') && contains(github.event.pull_request.labels.*.name, 'deployment')
    timeout-minutes: 5

    steps:
      - name: 🔄 Checkout code
        uses: actions/checkout@692973e3d937129bcbf40652eb9f2f61becf3332 # v4.1.7

      - name: ✅ Wait for status checks
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Waiting for status checks to complete..."
          PR_NUMBER=${{ github.event.pull_request.number }}

          # Wait up to 5 minutes for checks to complete
          for i in {1..30}; do
            CHECKS_STATUS=$(gh pr checks $PR_NUMBER --json state --jq '.[] | select(.state != "SUCCESS" and .state != "SKIPPED") | .state')

            if [ -z "$CHECKS_STATUS" ]; then
              echo "✅ All status checks passed!"
              break
            fi

            echo "⏳ Waiting for checks... ($i/30)"
            sleep 10
          done

      - name: 🤖 Auto-merge PR
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_TITLE: ${{ github.event.pull_request.title }}
        run: |
          PR_NUMBER=${{ github.event.pull_request.number }}

          # Check if PR title contains auto-merge indicator
          if [[ "$PR_TITLE" == *"[auto-merge]"* ]]; then
            echo "🤖 Auto-merging deployment URL update PR..."

            # Merge the PR
            gh pr merge $PR_NUMBER --squash --delete-branch --subject "chore: update deployment URLs [skip ci]"

            echo "✅ Successfully merged PR #$PR_NUMBER"
            echo "🗑️ Branch deleted automatically"
          else
            echo "❌ PR title does not contain [auto-merge] - skipping auto-merge"
          fi

      - name: 📋 Summary
        run: |
          echo "## 🤖 Auto-merge Deployment URLs" >> $GITHUB_STEP_SUMMARY
          echo "**PR:** #${{ github.event.pull_request.number }}" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** Auto-merged successfully" >> $GITHUB_STEP_SUMMARY
          echo "**Files Updated:** deployment-url.txt, robots.txt, sitemap.xml" >> $GITHUB_STEP_SUMMARY
