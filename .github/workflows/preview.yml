name: Preview Deployment

on:
  pull_request:
    branches: [main]
    types: [opened, synchronize, reopened, ready_for_review]

# Ensure workflow has necessary permissions
permissions:
  contents: read
  pull-requests: write
  issues: write

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-preview:
    name: Build PR Preview
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false
    timeout-minutes: 10

    permissions:
      contents: read
      pull-requests: write
      issues: write # Required for commenting on PRs

    steps:
      - name: Checkout repository
        uses: actions/checkout@692973e3d937129bcbf40652eb9f2f61becf3332 # v4.1.7
        with:
          ref: ${{ github.event.pull_request.head.sha }}

      - name: Setup Node.js
        uses: actions/setup-node@1e60f620b9541d16bece96c5465dc8ee9832be0b # v4.0.3
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        run: npm ci --prefer-offline --no-audit

      - name: Build application
        run: npm run build
        env:
          NODE_ENV: production

      - name: Upload preview artifacts
        uses: actions/upload-artifact@834a144ee995460fba8ed112a2fc961b36a5ec5a # v4.3.6
        with:
          name: preview-build-${{ github.event.pull_request.number }}
          path: out/
          retention-days: 7

      - name: Comment PR with build status
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        continue-on-error: true # Don't fail the workflow if commenting fails
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            try {
              const comment = `## 🚀 Preview Build Complete

              ✅ **Build Status**: Successful
              📦 **Artifacts**: Available for download
              🔍 **Changes**: This PR includes changes to the portfolio

              ### Quick Links
              - 📱 [Production Site](https://ahmed-shehzad.github.io/Portfolio)
              - 🔗 [Build Artifacts](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})

              > Build completed from commit: \`${{ github.event.pull_request.head.sha }}\`

              ---
              *This preview build will be updated when you push new commits to this PR.*`;

              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: comment
              });
              console.log('✅ PR comment posted successfully');
            } catch (error) {
              console.error('❌ Failed to post PR comment:', error.message);
              // Don't throw - just log the error
            }

  validate-build:
    name: Validate Build Output
    runs-on: ubuntu-latest
    needs: [build-preview]
    if: github.event.pull_request.draft == false
    timeout-minutes: 10

    permissions:
      contents: read
      pull-requests: write
      issues: write # Required for commenting on PRs

    steps:
      - name: Download build artifacts
        uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16 # v4.1.8
        with:
          name: preview-build-${{ github.event.pull_request.number }}
          path: out/

      - name: Validate build structure
        run: |
          echo "🔍 Validating build structure..."

          # Check if essential files exist
          if [ ! -f "out/index.html" ]; then
            echo "❌ Missing index.html"
            exit 1
          fi

          if [ ! -d "out/_next" ]; then
            echo "❌ Missing _next directory"
            exit 1
          fi

          # Check file sizes (warn if unusually large)
          INDEX_SIZE=$(stat -f%z out/index.html 2>/dev/null || stat -c%s out/index.html)
          if [ "$INDEX_SIZE" -gt 1048576 ]; then # 1MB
            echo "⚠️  Warning: index.html is quite large (${INDEX_SIZE} bytes)"
          fi

          echo "✅ Build structure validation passed"
          echo "📊 Build statistics:"
          du -h out/ | tail -1

      - name: Comment validation results
        if: always()
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        continue-on-error: true # Don't fail the workflow if commenting fails
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            try {
              const status = '${{ job.status }}' === 'success' ? '✅ Valid' : '❌ Invalid';
              const comment = `## 🔍 Build Validation

              **Status**: ${status}

              ${status.includes('✅') ?
                'Build artifacts are valid and ready for deployment! 🎉' :
                'Build validation failed. Please check the build process.'
              }`;

              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: comment
              });
              console.log('✅ Validation comment posted successfully');
            } catch (error) {
              console.error('❌ Failed to post validation comment:', error.message);
              // Don't throw - just log the error
            }
