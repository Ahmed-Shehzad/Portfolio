name: Validate CI/CD Setup

on:
  workflow_dispatch:
  schedule:
    # Run validation daily at 2 AM UTC
    - cron: "0 2 * * *"

permissions:
  contents: read
  actions: read

jobs:
  validate-setup:
    name: Validate CI/CD Configuration
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Validate workflow files
        run: |
          echo "ðŸ” Validating GitHub Actions workflows..."

          WORKFLOWS_DIR=".github/workflows"
          REQUIRED_WORKFLOWS=(
            "vercel-deploy.yml"
            "branch-protection.yml"
            "dependency-updates.yml"
          )

          for workflow in "${REQUIRED_WORKFLOWS[@]}"; do
            if [ -f "$WORKFLOWS_DIR/$workflow" ]; then
              echo "âœ… Found: $workflow"

              # Basic YAML validation
              if python3 -c "import yaml; yaml.safe_load(open('$WORKFLOWS_DIR/$workflow'))" 2>/dev/null; then
                echo "âœ… Valid YAML: $workflow"
              else
                echo "âŒ Invalid YAML: $workflow"
                exit 1
              fi
            else
              echo "âŒ Missing: $workflow"
              exit 1
            fi
          done

      - name: Check required configuration files
        run: |
          echo "ðŸ“‹ Checking configuration files..."

          REQUIRED_FILES=(
            "vercel.json"
            "next.config.ts"
            ".audit-ci.json"
            ".github/lighthouse/lighthouse-config.js"
            ".github/CICD_SETUP.md"
          )

          for file in "${REQUIRED_FILES[@]}"; do
            if [ -f "$file" ]; then
              echo "âœ… Found: $file"
            else
              echo "âŒ Missing: $file"
              exit 1
            fi
          done

      - name: Validate Vercel configuration
        run: |
          echo "ðŸš€ Validating Vercel configuration..."

          # Check vercel.json structure
          if jq -e '.functions."src/app/api/resume-pdf/route.ts".memory' vercel.json > /dev/null; then
            echo "âœ… Vercel function memory configuration found"
          else
            echo "âŒ Missing Vercel function configuration"
            exit 1
          fi

          # Check for build configuration
          if jq -e '.build' vercel.json > /dev/null; then
            echo "âœ… Build configuration present"
          else
            echo "â„¹ï¸ No specific build configuration (using defaults)"
          fi

      - name: Check GitHub repository settings recommendations
        run: |
          echo "âš™ï¸ Repository settings validation..."

          # Check if this is running in a repository context
          if [ -n "${{ github.repository }}" ]; then
            echo "ðŸ“Š Repository: ${{ github.repository }}"
            echo "ðŸŒ¿ Default branch: ${{ github.event.repository.default_branch }}"

            # Recommendations for repository settings
            echo ""
            echo "ðŸ“‹ Recommended GitHub Settings:"
            echo "  1. Branch protection rules for 'main' branch"
            echo "  2. Required status checks: Quality Gates, Portfolio Quality Checks"
            echo "  3. Required secrets: VERCEL_TOKEN, VERCEL_ORG_ID, VERCEL_PROJECT_ID"
            echo "  4. Actions permissions: Read repository contents and metadata"
          fi

      - name: Validate documentation
        run: |
          echo "ðŸ“š Validating documentation..."

          # Check CI/CD setup guide
          if grep -q "Required Secrets" .github/CICD_SETUP.md; then
            echo "âœ… CI/CD setup documentation is comprehensive"
          else
            echo "âŒ CI/CD setup documentation is incomplete"
            exit 1
          fi

          # Check README CI/CD section
          if grep -q "CI/CD.*Deployment" README.md; then
            echo "âœ… README contains CI/CD information"
          else
            echo "âš ï¸ README missing CI/CD section"
          fi

      - name: Test workflow syntax
        run: |
          echo "ðŸ”§ Testing workflow syntax with act (simulation)..."

          # Download act for workflow validation
          curl -q https://raw.githubusercontent.com/nektos/act/master/install.sh | bash

          # Dry run validation of main workflow
          if ./bin/act --dry-run --workflows .github/workflows/vercel-deploy.yml; then
            echo "âœ… Vercel deploy workflow syntax is valid"
          else
            echo "âŒ Vercel deploy workflow has syntax issues"
            exit 1
          fi

      - name: Summary report
        run: |
          echo ""
          echo "ðŸŽ‰ CI/CD Setup Validation Summary"
          echo "================================="
          echo ""
          echo "âœ… All required workflow files present"
          echo "âœ… Configuration files validated"
          echo "âœ… Vercel deployment config verified"
          echo "âœ… Documentation comprehensive"
          echo "âœ… Workflow syntax validated"
          echo ""
          echo "ðŸš€ Your CI/CD pipeline is ready for:"
          echo "  â€¢ Automated quality gates"
          echo "  â€¢ Preview deployments on PRs"
          echo "  â€¢ Production deployments on main"
          echo "  â€¢ Security and performance monitoring"
          echo "  â€¢ Automated dependency management"
          echo ""
          echo "ðŸ“‹ Next Steps:"
          echo "  1. Configure GitHub secrets (VERCEL_*)"
          echo "  2. Set up branch protection rules"
          echo "  3. Merge changes to main for first deployment"
          echo "  4. Monitor deployment in Vercel dashboard"

      - name: Generate validation badge
        run: |
          # Create a simple validation status
          echo "CI/CD-Setup-Validated" > /tmp/validation-status.txt
          echo "âœ… Generated validation status"

      - name: Upload validation report
        uses: actions/upload-artifact@v4
        with:
          name: cicd-validation-report-${{ github.run_number }}
          path: |
            /tmp/validation-status.txt
          retention-days: 30
