= useBfcacheCompatible Hooks Suite
:toc:
:toc-placement: preamble
:sectnums:
:icons: font
:revdate: 2025-08-09
:revremark: Initial documentation

[.lead]
Utilities for timeouts, scroll listeners, and intersection observers that remain compatible with browser back/forward cache (bfcache).

== Overview
Browsers may snapshot pages for instant restoration (bfcache). Standard timers, listeners, and observers can continue running or become stale after restoration. These hooks ensure safe cleanup and reattachment.

== Exports
[cols="1,3"]
|===
|`useBfcacheCompatibleTimeout` |Manage cancellable timeouts cleared on `pagehide` and recreated on demand.
|`useBfcacheCompatibleScrollListener` |Scroll listener with rAF throttling, reattached on `pageshow` (persisted) event.
|`useBfcacheCompatibleIntersectionObserver` |IntersectionObserver that disconnects/reattaches around bfcache transitions.
|===

== Timeout Hook
[source,typescript]
----
const { setBfcacheTimeout, clearBfcacheTimeout, clearAllTimeouts } = useBfcacheCompatibleTimeout();
----

=== Behavior
* Tracks active timeout IDs in a Set.
* Clears all on `pagehide` (pre-snapshot) to avoid blocking restore.
* Removes each ID after execution.

== Scroll Listener Hook
[source,typescript]
----
useBfcacheCompatibleScrollListener(() => {
  // inexpensive scroll work
});
----

=== Features
* rAF-based throttling (`ticking` flag) to limit layout thrash.
* Reattaches if restored from bfcache (`pageshow.persisted`).
* Cleans up listeners on unmount.

== Intersection Observer Hook
[source,typescript]
----
const observerRef = useBfcacheCompatibleIntersectionObserver(ref, (entries) => {/*...*/}, { threshold: 0.2 });
----

=== Behavior
* Builds fresh observer instance after bfcache restore.
* Disconnects on `pagehide` for snapshot friendliness.
* Returns mutable ref to current observer.

== Events Used
* `pageshow` (persisted) — indicates bfcache restoration.
* `pagehide` — triggers cleanup prior to snapshot.

== Usage Tips
* Prefer these hooks for any long-lived listeners in route-level components.
* Pair with Web Worker offloading for heavy scroll/visibility work.

== Change History
[cols="1,1,3"]
|===
|*Version* |*Date* |*Changes*
|1.0.0 |2025-08-09 |Initial documentation
|===
